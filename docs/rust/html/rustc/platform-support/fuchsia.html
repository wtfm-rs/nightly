<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>*-unknown-fuchsia - The rustc book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-a631a4e8.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-46ab57f5.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>‚Üê</kbd> or <kbd>‚Üí</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">The rustc book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/rust-lang/rust/tree/HEAD/src/doc/rustc" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>
                        <a href="https://github.com/rust-lang/rust/edit/main/src/doc/rustc/src/platform-support/fuchsia.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <span class=fa-svg id="git-edit-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M421.7 220.3l-11.3 11.3-22.6 22.6-205 205c-6.6 6.6-14.8 11.5-23.8 14.1L30.8 511c-8.4 2.5-17.5 .2-23.7-6.1S-1.5 489.7 1 481.2L38.7 353.1c2.6-9 7.5-17.2 14.1-23.8l205-205 22.6-22.6 11.3-11.3 33.9 33.9 62.1 62.1 33.9 33.9zM96 353.9l-9.3 9.3c-.9 .9-1.6 2.1-2 3.4l-25.3 86 86-25.3c1.3-.4 2.5-1.1 3.4-2l9.3-9.3H112c-8.8 0-16-7.2-16-16V353.9zM453.3 19.3l39.4 39.4c25 25 25 65.5 0 90.5l-14.5 14.5-22.6 22.6-11.3 11.3-33.9-33.9-62.1-62.1L314.3 67.7l11.3-11.3 22.6-22.6 14.5-14.5c25-25 65.5-25 90.5 0z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="aarch64-unknown-fuchsia-and-x86_64-unknown-fuchsia"><a class="header" href="#aarch64-unknown-fuchsia-and-x86_64-unknown-fuchsia"><code>aarch64-unknown-fuchsia</code> and <code>x86_64-unknown-fuchsia</code></a></h1>
<p><strong>Tier: 2</strong></p>
<p><a href="https://fuchsia.dev/">Fuchsia</a> is a modern open source operating system that‚Äôs simple, secure,
updatable, and performant.</p>
<h2 id="target-maintainers"><a class="header" href="#target-maintainers">Target maintainers</a></h2>
<p><a href="https://github.com/erickt">@erickt</a>
<a href="https://github.com/Nashenas88">@Nashenas88</a></p>
<p>The up-to-date list can be also found via the
<a href="https://github.com/rust-lang/team/blob/master/teams/fuchsia.toml">fuchsia marker team</a>.</p>
<h2 id="table-of-contents"><a class="header" href="#table-of-contents">Table of contents</a></h2>
<ol>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#walkthrough-structure">Walkthrough structure</a></li>
<li><a href="#compiling-a-rust-binary-targeting-fuchsia">Compiling a Rust binary targeting Fuchsia</a>
<ol>
<li><a href="#targeting-fuchsia-with-rustup-and-cargo">Targeting Fuchsia with rustup and cargo</a></li>
<li><a href="#targeting-fuchsia-with-a-compiler-built-from-source">Targeting Fuchsia with a compiler built from source</a></li>
</ol>
</li>
<li><a href="#creating-a-fuchsia-package">Creating a Fuchsia package</a>
<ol>
<li><a href="#creating-a-fuchsia-component">Creating a Fuchsia component</a></li>
<li><a href="#building-a-fuchsia-package">Building a Fuchsia package</a></li>
</ol>
</li>
<li><a href="#publishing-a-fuchsia-package">Publishing a Fuchsia package</a>
<ol>
<li><a href="#creating-a-fuchsia-package-repository">Creating a Fuchsia package repository</a></li>
<li><a href="#publishing-fuchsia-package-to-repository">Publishing Fuchsia package to repository</a></li>
</ol>
</li>
<li><a href="#running-a-fuchsia-component-on-an-emulator">Running a Fuchsia component on an emulator</a>
<ol>
<li><a href="#starting-the-fuchsia-emulator">Starting the Fuchsia emulator</a></li>
<li><a href="#watching-emulator-logs">Watching emulator logs</a></li>
<li><a href="#serving-a-fuchsia-package">Serving a Fuchsia package</a></li>
<li><a href="#running-a-fuchsia-component">Running a Fuchsia component</a></li>
</ol>
</li>
<li><a href="#gitignore-extensions"><code>.gitignore</code> extensions</a></li>
<li><a href="#testing">Testing</a>
<ol>
<li><a href="#running-unit-tests">Running unit tests</a></li>
<li><a href="#running-the-compiler-test-suite">Running the compiler test suite</a></li>
</ol>
</li>
<li><a href="#debugging">Debugging</a>
<ol>
<li><a href="#zxdb"><code>zxdb</code></a></li>
<li><a href="#attaching-zxdb">Attaching <code>zxdb</code></a></li>
<li><a href="#using-zxdb">Using <code>zxdb</code></a></li>
<li><a href="#displaying-source-code-in-zxdb">Displaying source code in <code>zxdb</code></a></li>
</ol>
</li>
</ol>
<h2 id="requirements"><a class="header" href="#requirements">Requirements</a></h2>
<p>This target is cross-compiled from a host environment. You will need a recent
copy of the <a href="https://chrome-infra-packages.appspot.com/p/fuchsia/sdk/core">Fuchsia SDK</a>, which provides the tools, libraries, and binaries
required to build and link programs for Fuchsia.</p>
<p>Development may also be done from the <a href="https://fuchsia.dev/fuchsia-src/get-started/learn/build">source tree</a>.</p>
<p>Fuchsia targets support <code>std</code> and follow the <code>sysv64</code> calling convention on
x86_64. Fuchsia binaries use the ELF file format.</p>
<h2 id="walkthrough-structure"><a class="header" href="#walkthrough-structure">Walkthrough structure</a></h2>
<p>This walkthrough will cover:</p>
<ol>
<li>Compiling a Rust binary targeting Fuchsia.</li>
<li>Building a Fuchsia package.</li>
<li>Publishing and running a Fuchsia package to a Fuchsia emulator.</li>
</ol>
<p>For the purposes of this walkthrough, we will only target <code>x86_64-unknown-fuchsia</code>.</p>
<h2 id="compiling-a-rust-binary-targeting-fuchsia"><a class="header" href="#compiling-a-rust-binary-targeting-fuchsia">Compiling a Rust binary targeting Fuchsia</a></h2>
<p>Today, there are two main ways to build a Rust binary targeting Fuchsia
using the Fuchsia SDK:</p>
<ol>
<li>Allow <a href="https://rustup.rs/">rustup</a> to handle the installation of Fuchsia targets for you.</li>
<li>Build a toolchain locally that can target Fuchsia.</li>
</ol>
<h3 id="targeting-fuchsia-with-rustup-and-cargo"><a class="header" href="#targeting-fuchsia-with-rustup-and-cargo">Targeting Fuchsia with rustup and cargo</a></h3>
<p>The easiest way to build a Rust binary targeting Fuchsia is by allowing <a href="https://rustup.rs/">rustup</a>
to handle the installation of Fuchsia targets for you. This can be done by issuing
the following commands:</p>
<pre><code class="language-sh">rustup target add x86_64-unknown-fuchsia
rustup target add aarch64-unknown-fuchsia
</code></pre>
<p>After installing our Fuchsia targets, we can now compile a Rust binary that targets
Fuchsia.</p>
<p>To create our Rust project, we can use <a href="../../cargo/index.html"><code>cargo</code></a> as follows:</p>
<p><strong>From base working directory</strong></p>
<pre><code class="language-sh">cargo new hello_fuchsia
</code></pre>
<p>The rest of this walkthrough will take place from <code>hello_fuchsia</code>, so we can
change into that directory now:</p>
<pre><code class="language-sh">cd hello_fuchsia
</code></pre>
<p><em>Note: From this point onwards, all commands will be issued from the <code>hello_fuchsia/</code>
directory, and all <code>hello_fuchsia/</code> prefixes will be removed from references for sake of brevity.</em></p>
<p>We can edit our <code>src/main.rs</code> to include a test as follows:</p>
<p><strong><code>src/main.rs</code></strong></p>
<pre><code class="language-rust">fn main() {
    println!("Hello Fuchsia!");
}

#[test]
fn it_works() {
    assert_eq!(2 + 2, 4);
}</code></pre>
<p>In addition to the standard workspace created, we will want to create a
<code>.cargo/config.toml</code> file to link necessary libraries
during compilation:</p>
<p><strong><code>.cargo/config.toml</code></strong></p>
<pre><code class="language-txt">[target.x86_64-unknown-fuchsia]

rustflags = [
    "-Lnative=&lt;SDK_PATH&gt;/arch/x64/lib",
    "-Lnative=&lt;SDK_PATH&gt;/arch/x64/sysroot/lib"
]
</code></pre>
<p><em>Note: Make sure to fill out <code>&lt;SDK_PATH&gt;</code> with the path to the downloaded <a href="https://chrome-infra-packages.appspot.com/p/fuchsia/sdk/core">Fuchsia SDK</a>.</em></p>
<p>These options configure the following:</p>
<ul>
<li><code>-Lnative=${SDK_PATH}/arch/${ARCH}/lib</code>: Link against Fuchsia libraries from
the SDK</li>
<li><code>-Lnative=${SDK_PATH}/arch/${ARCH}/sysroot/lib</code>: Link against Fuchsia sysroot
libraries from the SDK</li>
</ul>
<p>In total, our new project will look like:</p>
<p><strong>Current directory structure</strong></p>
<pre><code class="language-txt">hello_fuchsia/
‚î£‚îÅ src/
‚îÉ  ‚îó‚îÅ main.rs
‚î£‚îÅ Cargo.toml
‚îó‚îÅ .cargo/
   ‚îó‚îÅ config.toml
</code></pre>
<p>Finally, we can build our rust binary as:</p>
<pre><code class="language-sh">cargo build --target x86_64-unknown-fuchsia
</code></pre>
<p>Now we have a Rust binary at <code>target/x86_64-unknown-fuchsia/debug/hello_fuchsia</code>,
targeting our desired Fuchsia target.</p>
<p><strong>Current directory structure</strong></p>
<pre><code class="language-txt">hello_fuchsia/
‚î£‚îÅ src/
‚îÉ  ‚îó‚îÅ main.rs
‚î£‚îÅ target/
‚îÉ  ‚îó‚îÅ x86_64-unknown-fuchsia/
‚îÉ     ‚îó‚îÅ debug/
‚îÉ        ‚îó‚îÅ hello_fuchsia
‚î£‚îÅ Cargo.toml
‚îó‚îÅ .cargo/
   ‚îó‚îÅ config.toml
</code></pre>
<h3 id="targeting-fuchsia-with-a-compiler-built-from-source"><a class="header" href="#targeting-fuchsia-with-a-compiler-built-from-source">Targeting Fuchsia with a compiler built from source</a></h3>
<p>An alternative to the first workflow is to target Fuchsia by using
<code>rustc</code> built from source.</p>
<p>Before building Rust for Fuchsia, you‚Äôll need a clang toolchain that supports
Fuchsia as well. A recent version (14+) of clang should be sufficient to compile
Rust for Fuchsia.</p>
<p>x86-64 and AArch64 Fuchsia targets can be enabled using the following
configuration in <code>bootstrap.toml</code>:</p>
<pre><code class="language-toml">[build]
target = ["&lt;host_platform&gt;", "aarch64-unknown-fuchsia", "x86_64-unknown-fuchsia"]

[rust]
lld = true

[llvm]
download-ci-llvm = false

[target.x86_64-unknown-fuchsia]
cc = "clang"
cxx = "clang++"

[target.aarch64-unknown-fuchsia]
cc = "clang"
cxx = "clang++"
</code></pre>
<p>Though not strictly required, you may also want to use <code>clang</code> for your host
target as well:</p>
<pre><code class="language-toml">[target.&lt;host_platform&gt;]
cc = "clang"
cxx = "clang++"
</code></pre>
<p>By default, the Rust compiler installs itself to <code>/usr/local</code> on most UNIX
systems. You may want to install it to another location (e.g. a local <code>install</code>
directory) by setting a custom prefix in <code>bootstrap.toml</code>:</p>
<pre><code class="language-toml">[install]
# Make sure to use the absolute path to your install directory
prefix = "&lt;RUST_SRC_PATH&gt;/install"
</code></pre>
<p>Next, the following environment variables must be configured. For example, using
a script we name <code>config-env.sh</code>:</p>
<pre><code class="language-sh"># Configure this environment variable to be the path to the downloaded SDK
export SDK_PATH="&lt;SDK path goes here&gt;"

export CFLAGS_aarch64_unknown_fuchsia="--target=aarch64-unknown-fuchsia --sysroot=${SDK_PATH}/arch/arm64/sysroot -I${SDK_PATH}/pkg/fdio/include"
export CXXFLAGS_aarch64_unknown_fuchsia="--target=aarch64-unknown-fuchsia --sysroot=${SDK_PATH}/arch/arm64/sysroot -I${SDK_PATH}/pkg/fdio/include"
export LDFLAGS_aarch64_unknown_fuchsia="--target=aarch64-unknown-fuchsia --sysroot=${SDK_PATH}/arch/arm64/sysroot -L${SDK_PATH}/arch/arm64/lib"
export CARGO_TARGET_AARCH64_UNKNOWN_FUCHSIA_RUSTFLAGS="-C link-arg=--sysroot=${SDK_PATH}/arch/arm64/sysroot -Lnative=${SDK_PATH}/arch/arm64/sysroot/lib -Lnative=${SDK_PATH}/arch/arm64/lib"
export CFLAGS_x86_64_unknown_fuchsia="--target=x86_64-unknown-fuchsia --sysroot=${SDK_PATH}/arch/x64/sysroot -I${SDK_PATH}/pkg/fdio/include"
export CXXFLAGS_x86_64_unknown_fuchsia="--target=x86_64-unknown-fuchsia --sysroot=${SDK_PATH}/arch/x64/sysroot -I${SDK_PATH}/pkg/fdio/include"
export LDFLAGS_x86_64_unknown_fuchsia="--target=x86_64-unknown-fuchsia --sysroot=${SDK_PATH}/arch/x64/sysroot -L${SDK_PATH}/arch/x64/lib"
export CARGO_TARGET_X86_64_UNKNOWN_FUCHSIA_RUSTFLAGS="-C link-arg=--sysroot=${SDK_PATH}/arch/x64/sysroot -Lnative=${SDK_PATH}/arch/x64/sysroot/lib -Lnative=${SDK_PATH}/arch/x64/lib"
</code></pre>
<p>Finally, the Rust compiler can be built and installed:</p>
<pre><code class="language-sh">(source config-env.sh &amp;&amp; ./x.py install)
</code></pre>
<p>Once <code>rustc</code> is installed, we can create a new working directory to work from,
<code>hello_fuchsia</code> along with <code>hello_fuchsia/src</code>:</p>
<pre><code class="language-sh">mkdir hello_fuchsia
cd hello_fuchsia
mkdir src
</code></pre>
<p><em>Note: From this point onwards, all commands will be issued from the <code>hello_fuchsia/</code>
directory, and all <code>hello_fuchsia/</code> prefixes will be removed from references for sake of brevity.</em></p>
<p>There, we can create a new file named <code>src/hello_fuchsia.rs</code>:</p>
<p><strong><code>src/hello_fuchsia.rs</code></strong></p>
<pre><code class="language-rust">fn main() {
    println!("Hello Fuchsia!");
}

#[test]
fn it_works() {
    assert_eq!(2 + 2, 4);
}</code></pre>
<p><strong>Current directory structure</strong></p>
<pre><code class="language-txt">hello_fuchsia/
‚îó‚îÅ src/
    ‚îó‚îÅ hello_fuchsia.rs
</code></pre>
<p>Using your freshly installed <code>rustc</code>, you can compile a binary for Fuchsia using
the following options:</p>
<ul>
<li><code>--target x86_64-unknown-fuchsia</code>/<code>--target aarch64-unknown-fuchsia</code>: Targets the Fuchsia
platform of your choice</li>
<li><code>-Lnative ${SDK_PATH}/arch/${ARCH}/lib</code>: Link against Fuchsia libraries from
the SDK</li>
<li><code>-Lnative ${SDK_PATH}/arch/${ARCH}/sysroot/lib</code>: Link against Fuchsia sysroot
libraries from the SDK</li>
</ul>
<p>Putting it all together:</p>
<pre><code class="language-sh"># Configure these for the Fuchsia target of your choice
TARGET_ARCH="&lt;x86_64-unknown-fuchsia|aarch64-unknown-fuchsia&gt;"
ARCH="&lt;x64|aarch64&gt;"

rustc \
    --target ${TARGET_ARCH} \
    -Lnative=${SDK_PATH}/arch/${ARCH}/lib \
    -Lnative=${SDK_PATH}/arch/${ARCH}/sysroot/lib \
    --out-dir bin src/hello_fuchsia.rs
</code></pre>
<p><strong>Current directory structure</strong></p>
<pre><code class="language-txt">hello_fuchsia/
‚î£‚îÅ src/
‚îÉ   ‚îó‚îÅ hello_fuchsia.rs
‚îó‚îÅ bin/
   ‚îó‚îÅ hello_fuchsia
</code></pre>
<h2 id="creating-a-fuchsia-package"><a class="header" href="#creating-a-fuchsia-package">Creating a Fuchsia package</a></h2>
<p>Before moving on, double check your directory structure:</p>
<p><strong>Current directory structure</strong></p>
<pre><code class="language-txt">hello_fuchsia/
‚î£‚îÅ src/                         (if using rustc)
‚îÉ   ‚îó‚îÅ hello_fuchsia.rs         ...
‚î£‚îÅ bin/                         ...
‚îÉ  ‚îó‚îÅ hello_fuchsia             ...
‚î£‚îÅ src/                         (if using cargo)
‚îÉ  ‚îó‚îÅ main.rs                   ...
‚îó‚îÅ target/                      ...
   ‚îó‚îÅ x86_64-unknown-fuchsia/   ...
      ‚îó‚îÅ debug/                 ...
         ‚îó‚îÅ hello_fuchsia       ...
</code></pre>
<p>With our Rust binary built, we can move to creating a Fuchsia package.
On Fuchsia, a package is the unit of distribution for software. We‚Äôll need to
create a new package directory where we will place files like our finished
binary and any data it may need.</p>
<p>To start, make the <code>pkg</code>, and <code>pkg/meta</code> directories:</p>
<pre><code class="language-sh">mkdir pkg
mkdir pkg/meta
</code></pre>
<p><strong>Current directory structure</strong></p>
<pre><code class="language-txt">hello_fuchsia/
‚îó‚îÅ pkg/
   ‚îó‚îÅ meta/
</code></pre>
<p>Now, create the following files inside:</p>
<p><strong><code>pkg/meta/package</code></strong></p>
<pre><code class="language-json">{
  "name": "hello_fuchsia",
  "version": "0"
}
</code></pre>
<p>The <code>package</code> file describes our package‚Äôs name and version number. Every
package must contain one.</p>
<p><strong><code>pkg/hello_fuchsia.manifest</code> if using cargo</strong></p>
<pre><code class="language-txt">bin/hello_fuchsia=target/x86_64-unknown-fuchsia/debug/hello_fuchsia
lib/ld.so.1=&lt;SDK_PATH&gt;/arch/x64/sysroot/dist/lib/ld.so.1
lib/libfdio.so=&lt;SDK_PATH&gt;/arch/x64/dist/libfdio.so
meta/package=pkg/meta/package
meta/hello_fuchsia.cm=pkg/meta/hello_fuchsia.cm
</code></pre>
<p><strong><code>pkg/hello_fuchsia.manifest</code> if using rustc</strong></p>
<pre><code class="language-txt">bin/hello_fuchsia=bin/hello_fuchsia
lib/ld.so.1=&lt;SDK_PATH&gt;/arch/x64/sysroot/dist/lib/ld.so.1
lib/libfdio.so=&lt;SDK_PATH&gt;/arch/x64/dist/libfdio.so
meta/package=pkg/meta/package
meta/hello_fuchsia.cm=pkg/meta/hello_fuchsia.cm
</code></pre>
<p><em>Note: Relative manifest paths are resolved starting from the working directory
of <code>ffx</code>. Make sure to fill out <code>&lt;SDK_PATH&gt;</code> with the path to the downloaded
SDK.</em></p>
<p>The <code>.manifest</code> file will be used to describe the contents of the package by
relating their location when installed to their location on the file system. The
<code>bin/hello_fuchsia=</code> entry will be different depending on how your Rust binary
was built, so choose accordingly.</p>
<p><strong>Current directory structure</strong></p>
<pre><code class="language-txt">hello_fuchsia/
‚îó‚îÅ pkg/
   ‚î£‚îÅ meta/
   ‚îÉ  ‚îó‚îÅ package
   ‚îó‚îÅ hello_fuchsia.manifest
</code></pre>
<h3 id="creating-a-fuchsia-component"><a class="header" href="#creating-a-fuchsia-component">Creating a Fuchsia component</a></h3>
<p>On Fuchsia, components require a component manifest written in Fuchsia‚Äôs markup
language called CML. The Fuchsia devsite contains an <a href="https://fuchsia.dev/fuchsia-src/concepts/components/v2/component_manifests">overview of CML</a> and a
<a href="https://fuchsia.dev/reference/cml">reference for the file format</a>. Here‚Äôs a basic one that can run our single binary:</p>
<p><strong><code>pkg/hello_fuchsia.cml</code></strong></p>
<pre><code class="language-txt">{
    include: [ "syslog/client.shard.cml" ],
    program: {
        runner: "elf",
        binary: "bin/hello_fuchsia",
    },
}
</code></pre>
<p><strong>Current directory structure</strong></p>
<pre><code class="language-txt">hello_fuchsia/
‚îó‚îÅ pkg/
   ‚î£‚îÅ meta/
   ‚îÉ  ‚îó‚îÅ package
   ‚î£‚îÅ hello_fuchsia.manifest
   ‚îó‚îÅ hello_fuchsia.cml
</code></pre>
<p>Now we can compile that CML into a component manifest:</p>
<pre><code class="language-sh">${SDK_PATH}/tools/${ARCH}/cmc compile \
    pkg/hello_fuchsia.cml \
    --includepath ${SDK_PATH}/pkg \
    -o pkg/meta/hello_fuchsia.cm
</code></pre>
<p><em>Note: <code>--includepath</code> tells the compiler where to look for <code>include</code>s from our CML.
In our case, we‚Äôre only using <code>syslog/client.shard.cml</code>.</em></p>
<p><strong>Current directory structure</strong></p>
<pre><code class="language-txt">hello_fuchsia/
‚îó‚îÅ pkg/
   ‚î£‚îÅ meta/
   ‚îÉ  ‚î£‚îÅ package
   ‚îÉ  ‚îó‚îÅ hello_fuchsia.cm
   ‚î£‚îÅ hello_fuchsia.manifest
   ‚îó‚îÅ hello_fuchsia.cml
</code></pre>
<h3 id="building-a-fuchsia-package"><a class="header" href="#building-a-fuchsia-package">Building a Fuchsia package</a></h3>
<p>Next, we‚Äôll build a package manifest as defined by our manifest:</p>
<pre><code class="language-sh">${SDK_PATH}/tools/${ARCH}/ffx package build \
    --api-level $(${SDK_PATH}/tools/${ARCH}/ffx --machine json version | jq .tool_version.api_level) \
    --out pkg/hello_fuchsia_manifest \
    pkg/hello_fuchsia.manifest
</code></pre>
<p>This will produce <code>pkg/hello_fuchsia_manifest/</code> which is a package manifest we can
publish directly to a repository.</p>
<p><strong>Current directory structure</strong></p>
<pre><code class="language-txt">hello_fuchsia/
‚îó‚îÅ pkg/
   ‚î£‚îÅ meta/
   ‚îÉ  ‚î£‚îÅ package
   ‚îÉ  ‚îó‚îÅ hello_fuchsia.cm
   ‚î£‚îÅ hello_fuchsia_manifest/
   ‚îÉ  ‚îó‚îÅ ...
   ‚î£‚îÅ hello_fuchsia.manifest
   ‚î£‚îÅ hello_fuchsia.cml
   ‚îó‚îÅ hello_fuchsia_package_manifest
</code></pre>
<p>We are now ready to publish the package.</p>
<h2 id="publishing-a-fuchsia-package"><a class="header" href="#publishing-a-fuchsia-package">Publishing a Fuchsia package</a></h2>
<p>With our package and component manifests setup,
we can now publish our package. The first step will
be to create a Fuchsia package repository to publish
to.</p>
<h3 id="creating-a-fuchsia-package-repository"><a class="header" href="#creating-a-fuchsia-package-repository">Creating a Fuchsia package repository</a></h3>
<p>We can set up our repository with:</p>
<pre><code class="language-sh">${SDK_PATH}/tools/${ARCH}/ffx repository create pkg/repo
</code></pre>
<p><strong>Current directory structure</strong></p>
<pre><code class="language-txt">hello_fuchsia/
‚îó‚îÅ pkg/
   ‚î£‚îÅ meta/
   ‚îÉ  ‚î£‚îÅ package
   ‚îÉ  ‚îó‚îÅ hello_fuchsia.cm
   ‚î£‚îÅ hello_fuchsia_manifest/
   ‚îÉ  ‚îó‚îÅ ...
   ‚î£‚îÅ repo/
   ‚îÉ  ‚îó‚îÅ ...
   ‚î£‚îÅ hello_fuchsia.manifest
   ‚î£‚îÅ hello_fuchsia.cml
   ‚îó‚îÅ hello_fuchsia_package_manifest
</code></pre>
<h2 id="publishing-fuchsia-package-to-repository"><a class="header" href="#publishing-fuchsia-package-to-repository">Publishing Fuchsia package to repository</a></h2>
<p>We can publish our new package to that repository with:</p>
<pre><code class="language-sh">${SDK_PATH}/tools/${ARCH}/ffx repository publish \
    --package pkg/hello_fuchsia_package_manifest \
    pkg/repo
</code></pre>
<h2 id="running-a-fuchsia-component-on-an-emulator"><a class="header" href="#running-a-fuchsia-component-on-an-emulator">Running a Fuchsia component on an emulator</a></h2>
<p>At this point, we are ready to run our Fuchsia
component. For reference, our final directory
structure will look like:</p>
<p><strong>Final directory structure</strong></p>
<pre><code class="language-txt">hello_fuchsia/
‚î£‚îÅ src/                         (if using rustc)
‚îÉ   ‚îó‚îÅ hello_fuchsia.rs         ...
‚î£‚îÅ bin/                         ...
‚îÉ  ‚îó‚îÅ hello_fuchsia             ...
‚î£‚îÅ src/                         (if using cargo)
‚îÉ  ‚îó‚îÅ main.rs                   ...
‚î£‚îÅ target/                      ...
‚îÉ  ‚îó‚îÅ x86_64-unknown-fuchsia/   ...
‚îÉ     ‚îó‚îÅ debug/                 ...
‚îÉ        ‚îó‚îÅ hello_fuchsia       ...
‚îó‚îÅ pkg/
   ‚î£‚îÅ meta/
   ‚îÉ  ‚î£‚îÅ package
   ‚îÉ  ‚îó‚îÅ hello_fuchsia.cm
   ‚î£‚îÅ hello_fuchsia_manifest/
   ‚îÉ  ‚îó‚îÅ ...
   ‚î£‚îÅ repo/
   ‚îÉ  ‚îó‚îÅ ...
   ‚î£‚îÅ hello_fuchsia.manifest
   ‚î£‚îÅ hello_fuchsia.cml
   ‚îó‚îÅ hello_fuchsia_package_manifest
</code></pre>
<h3 id="starting-the-fuchsia-emulator"><a class="header" href="#starting-the-fuchsia-emulator">Starting the Fuchsia emulator</a></h3>
<p>Start a Fuchsia emulator in a new terminal using:</p>
<pre><code class="language-sh">${SDK_PATH}/tools/${ARCH}/ffx product-bundle get workstation_eng.qemu-${ARCH}
${SDK_PATH}/tools/${ARCH}/ffx emu start workstation_eng.qemu-${ARCH} --headless
</code></pre>
<h3 id="watching-emulator-logs"><a class="header" href="#watching-emulator-logs">Watching emulator logs</a></h3>
<p>Once the emulator is running, open a separate terminal to watch the emulator logs:</p>
<p><strong>In separate terminal</strong></p>
<pre><code class="language-sh">${SDK_PATH}/tools/${ARCH}/ffx log \
    --since now
</code></pre>
<h3 id="serving-a-fuchsia-package"><a class="header" href="#serving-a-fuchsia-package">Serving a Fuchsia package</a></h3>
<p>Now, start a package repository server to serve our
package to the emulator:</p>
<pre><code class="language-sh">${SDK_PATH}/tools/${ARCH}/ffx repository server start \
    --background --repository hello-fuchsia --repo-path pkg-repo
</code></pre>
<p>Once the repository server is up and running, register it with the target Fuchsia system running in the emulator:</p>
<pre><code class="language-sh">${SDK_PATH}/tools/${ARCH}/ffx target repository register \
    --repository hello-fuchsia
</code></pre>
<h3 id="running-a-fuchsia-component"><a class="header" href="#running-a-fuchsia-component">Running a Fuchsia component</a></h3>
<p>Finally, run the component:</p>
<pre><code class="language-sh">${SDK_PATH}/tools/${ARCH}/ffx component run \
    /core/ffx-laboratory:hello_fuchsia \
    fuchsia-pkg://hello-fuchsia/hello_fuchsia_manifest#meta/hello_fuchsia.cm
</code></pre>
<p>On reruns of the component, the <code>--recreate</code> argument may also need to be
passed.</p>
<pre><code class="language-sh">${SDK_PATH}/tools/${ARCH}/ffx component run \
    --recreate \
    /core/ffx-laboratory:hello_fuchsia \
    fuchsia-pkg://hello-fuchsia/hello_fuchsia_manifest#meta/hello_fuchsia.cm
</code></pre>
<h2 id="gitignore-extensions"><a class="header" href="#gitignore-extensions"><code>.gitignore</code> extensions</a></h2>
<p>Optionally, we can create/extend our <code>.gitignore</code> file to ignore files and
directories that are not helpful to track:</p>
<pre><code class="language-txt">pkg/repo
pkg/meta/hello_fuchsia.cm
pkg/hello_fuchsia_manifest
pkg/hello_fuchsia_package_manifest
</code></pre>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<h3 id="running-unit-tests"><a class="header" href="#running-unit-tests">Running unit tests</a></h3>
<p>Tests can be run in the same way as a regular binary.</p>
<ul>
<li>
<p>If using <code>cargo</code>, you can simply pass <code>test --no-run</code>
to the <code>cargo</code> invocation and then repackage and rerun the Fuchsia package. From our previous example,
this would look like <code>cargo test --target x86_64-unknown-fuchsia --no-run</code>, and moving the executable
binary path found from the line <code>Executable unittests src/main.rs (target/x86_64-unknown-fuchsia/debug/deps/hello_fuchsia-&lt;HASH&gt;)</code>
into <code>pkg/hello_fuchsia.manifest</code>.</p>
</li>
<li>
<p>If using the compiled <code>rustc</code>, you can simply pass <code>--test</code>
to the <code>rustc</code> invocation and then repackage and rerun the Fuchsia package.</p>
</li>
</ul>
<p>The test harness will run the applicable unit tests.</p>
<p>Often when testing, you may want to pass additional command line arguments to
your binary. Additional arguments can be set in the component manifest:</p>
<p><strong><code>pkg/hello_fuchsia.cml</code></strong></p>
<pre><code class="language-txt">{
    include: [ "syslog/client.shard.cml" ],
    program: {
        runner: "elf",
        binary: "bin/hello_fuchsia",
        args: ["it_works"],
    },
}
</code></pre>
<p>This will pass the argument <code>it_works</code> to the binary, filtering the tests to
only those tests that match the pattern. There are many more configuration
options available in CML including environment variables. More documentation is
available on the <a href="https://fuchsia.dev/reference/cml">Fuchsia devsite</a>.</p>
<h3 id="running-the-compiler-test-suite"><a class="header" href="#running-the-compiler-test-suite">Running the compiler test suite</a></h3>
<p>The commands in this section assume that they are being run from inside your
local Rust source checkout:</p>
<pre><code class="language-sh">cd ${RUST_SRC_PATH}
</code></pre>
<p>To run the Rust test suite on an emulated Fuchsia device, you‚Äôll also need to
download a copy of the Fuchsia SDK. The current minimum supported SDK version is
<a href="https://chrome-infra-packages.appspot.com/p/fuchsia/sdk/core/linux-amd64/+/version:20.20240412.3.1">20.20240412.3.1</a>.</p>
<p>Fuchsia‚Äôs test runner interacts with the Fuchsia emulator and is located at
<code>src/ci/docker/scripts/fuchsia-test-runner.py</code>. First, add the following
variables to your existing <code>config-env.sh</code>:</p>
<pre><code class="language-sh"># TEST_TOOLCHAIN_TMP_DIR can point anywhere, but it:
#  - must be less than 108 characters, otherwise qemu can't handle the path
#  - must be consistent across calls to this file (don't use `mktemp -d` here)
export TEST_TOOLCHAIN_TMP_DIR="/tmp/rust-tmp"

# Keep existing contents of `config-env.sh` from earlier, including SDK_PATH
</code></pre>
<p>We can then use the script to start our test environment with:</p>
<pre><code class="language-sh">( \
    source config-env.sh &amp;&amp;                                                   \
    src/ci/docker/scripts/fuchsia-test-runner.py start                        \
    --rust-build ${RUST_SRC_PATH}/build                                       \
    --sdk ${SDK_PATH}                                                         \
    --target {x86_64-unknown-fuchsia|aarch64-unknown-fuchsia}                 \
    --verbose                                                                 \
)
</code></pre>
<p>Where <code>${RUST_SRC_PATH}/build</code> is the <code>build-dir</code> set in <code>bootstrap.toml</code>.</p>
<p>Once our environment is started, we can run our tests using <code>x.py</code> as usual. The
test runner script will run the compiled tests on an emulated Fuchsia device. To
run the full <code>tests/ui</code> test suite:</p>
<pre><code class="language-sh">( \
    source config-env.sh &amp;&amp;                                                   \
    ./x.py                                                                    \
    --config bootstrap.toml                                                      \
    --stage=2                                                                 \
    test tests/ui                                                             \
    --target x86_64-unknown-fuchsia                                           \
    --run=always                                                              \
    --test-args --target-rustcflags                                           \
    --test-args -Lnative=${SDK_PATH}/arch/{x64|arm64}/sysroot/lib             \
    --test-args --target-rustcflags                                           \
    --test-args -Lnative=${SDK_PATH}/arch/{x64|arm64}/lib                     \
    --test-args --target-rustcflags                                           \
    --test-args -Clink-arg=--undefined-version                                \
    --test-args --remote-test-client                                          \
    --test-args src/ci/docker/scripts/fuchsia-test-runner.py                  \
)
</code></pre>
<p>By default, <code>x.py</code> compiles test binaries with <code>panic=unwind</code>. If you built your
Rust toolchain with <code>-Cpanic=abort</code>, you need to tell <code>x.py</code> to compile test
binaries with <code>panic=abort</code> as well:</p>
<pre><code class="language-sh">    --test-args --target-rustcflags                                           \
    --test-args -Cpanic=abort                                                 \
    --test-args --target-rustcflags                                           \
    --test-args -Zpanic_abort_tests                                           \
</code></pre>
<p>When finished testing, the test runner can be used to stop the test environment:</p>
<pre><code class="language-sh">src/ci/docker/scripts/fuchsia-test-runner.py stop
</code></pre>
<h2 id="debugging"><a class="header" href="#debugging">Debugging</a></h2>
<h3 id="zxdb"><a class="header" href="#zxdb"><code>zxdb</code></a></h3>
<p>Debugging components running on a Fuchsia emulator can be done using the
console-mode debugger: <a href="https://fuchsia.dev/fuchsia-src/development/debugger">zxdb</a>. We will demonstrate attaching necessary symbol
paths to debug our <code>hello-fuchsia</code> component.</p>
<h3 id="attaching-zxdb"><a class="header" href="#attaching-zxdb">Attaching <code>zxdb</code></a></h3>
<p>In a separate terminal, issue the following command from our <code>hello_fuchsia</code>
directory to launch <code>zxdb</code>:</p>
<p><strong>In separate terminal</strong></p>
<pre><code class="language-sh">${SDK_PATH}/tools/${ARCH}/ffx debug connect -- \
    --symbol-path target/x86_64-unknown-fuchsia/debug
</code></pre>
<ul>
<li><code>--symbol-path</code> gets required symbol paths, which are
necessary for stepping through your program.</li>
</ul>
<p>The ‚Äú<a href="#displaying-source-code-in-zxdb">displaying source code in <code>zxdb</code></a>‚Äù
section describes how you can display Rust and/or Fuchsia source code in your
debugging session.</p>
<h3 id="using-zxdb"><a class="header" href="#using-zxdb">Using <code>zxdb</code></a></h3>
<p>Once launched, you will be presented with the window:</p>
<pre><code class="language-sh">Connecting (use "disconnect" to cancel)...
Connected successfully.
üëâ To get started, try "status" or "help".
[zxdb]
</code></pre>
<p>To attach to our program, we can run:</p>
<pre><code class="language-sh">[zxdb] attach hello_fuchsia
</code></pre>
<p><strong>Expected output</strong></p>
<pre><code class="language-sh">Waiting for process matching "hello_fuchsia".
Type "filter" to see the current filters.
</code></pre>
<p>Next, we can create a breakpoint at main using ‚Äúb main‚Äù:</p>
<pre><code class="language-sh">[zxdb] b main
</code></pre>
<p><strong>Expected output</strong></p>
<pre><code class="language-sh">Created Breakpoint 1 @ main
</code></pre>
<p>Finally, we can re-run the ‚Äúhello_fuchsia‚Äù component from our original
terminal:</p>
<pre><code class="language-sh">${SDK_PATH}/tools/${ARCH}/ffx component run \
    --recreate \
    fuchsia-pkg://hello-fuchsia/hello_fuchsia_manifest#meta/hello_fuchsia.cm
</code></pre>
<p>Once our component is running, our <code>zxdb</code> window will stop execution
in our main as desired:</p>
<p><strong>Expected output</strong></p>
<pre><code class="language-txt">Breakpoint 1 now matching 1 addrs for main
üõë on bp 1 hello_fuchsia::main() ‚Ä¢ main.rs:2
   1 fn main() {
 ‚ñ∂ 2     println!("Hello Fuchsia!");
   3 }
   4
[zxdb]
</code></pre>
<p><code>zxdb</code> has similar commands to other debuggers like <a href="https://www.sourceware.org/gdb/">gdb</a>.
To list the available commands, run ‚Äúhelp‚Äù in the
<code>zxdb</code> window or visit <a href="https://fuchsia.dev/fuchsia-src/development/debugger">the zxdb documentation</a>.</p>
<pre><code class="language-sh">[zxdb] help
</code></pre>
<p><strong>Expected output</strong></p>
<pre><code class="language-sh">Help!

  Type "help &lt;command&gt;" for command-specific help.

Other help topics (see "help &lt;topic&gt;")
...
</code></pre>
<h3 id="displaying-source-code-in-zxdb"><a class="header" href="#displaying-source-code-in-zxdb">Displaying source code in <code>zxdb</code></a></h3>
<p>By default, the debugger will not be able to display
source code while debugging. For our user code, we displayed
source code by pointing our debugger to our debug binary via
the <code>--symbol-path</code> arg. To display library source code in
the debugger, you must provide paths to the source using
<code>--build-dir</code>. For example, to display the Rust and Fuchsia
source code:</p>
<pre><code class="language-sh">${SDK_PATH}/tools/${ARCH}/ffx debug connect -- \
    --symbol-path target/x86_64-unknown-fuchsia/debug \
    --build-dir ${RUST_SRC_PATH}/rust \
    --build-dir ${FUCHSIA_SRC_PATH}/fuchsia/out/default
</code></pre>
<ul>
<li><code>--build-dir</code> links against source code paths, which
are not strictly necessary for debugging, but is a nice-to-have
for displaying source code in <code>zxdb</code>.</li>
</ul>
<p>Linking to a Fuchsia checkout can help with debugging Fuchsia libraries,
such as <a href="https://cs.opensource.google/fuchsia/fuchsia/+/main:sdk/lib/fdio/">fdio</a>.</p>
<h3 id="debugging-the-compiler-test-suite"><a class="header" href="#debugging-the-compiler-test-suite">Debugging the compiler test suite</a></h3>
<p>Debugging the compiler test suite requires some special configuration:</p>
<p>First, we have to properly configure zxdb so it will be able to find debug
symbols and source information for our test. The test runner can do this for us
with:</p>
<pre><code class="language-sh">src/ci/docker/scripts/fuchsia-test-runner.py debug                            \
    --rust-src ${RUST_SRC_PATH}                                               \
    --fuchsia-src ${FUCHSIA_SRC_PATH}                                         \
    --test ${TEST}
</code></pre>
<p>where <code>${TEST}</code> is relative to Rust‚Äôs <code>tests</code> directory (e.g. <code>ui/abi/...</code>).</p>
<p>This will start a zxdb session that is properly configured for the specific test
being run. All three arguments are optional, so you can omit <code>--fuchsia-src</code> if
you don‚Äôt have it downloaded. Now is a good time to set any desired breakpoints,
like <code>b main</code>.</p>
<p>Next, we have to tell <code>x.py</code> not to optimize or strip debug symbols from our
test suite binaries. We can do this by passing some new arguments to <code>rustc</code>
through our <code>x.py</code> invocation. The full invocation is:</p>
<pre><code class="language-sh">( \
    source config-env.sh &amp;&amp;                                                   \
    ./x.py                                                                    \
    --config bootstrap.toml                                                      \
    --stage=2                                                                 \
    test tests/${TEST}                                                        \
    --target x86_64-unknown-fuchsia                                           \
    --run=always                                                              \
    --test-args --target-rustcflags                                           \
    --test-args -Lnative=${SDK_PATH}/arch/{x64|arm64}/sysroot/lib             \
    --test-args --target-rustcflags                                           \
    --test-args -Lnative=${SDK_PATH}/arch/{x64|arm64}/lib                     \
    --test-args --target-rustcflags                                           \
    --test-args -Clink-arg=--undefined-version                                \
    --test-args --target-rustcflags                                           \
    --test-args -Cdebuginfo=2                                                 \
    --test-args --target-rustcflags                                           \
    --test-args -Copt-level=0                                                 \
    --test-args --target-rustcflags                                           \
    --test-args -Cstrip=none                                                  \
    --test-args --remote-test-client                                          \
    --test-args src/ci/docker/scripts/fuchsia-test-runner.py                  \
)
</code></pre>
<p><em>If you built your Rust toolchain with <code>panic=abort</code>, make sure to include the
previous flags so your test binaries are also compiled with <code>panic=abort</code>.</em></p>
<p>Upon running this command, the test suite binary will be run and zxdb will
attach and load any relevant debug symbols.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../platform-support/esp-idf.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../platform-support/trusty.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../platform-support/esp-idf.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../platform-support/trusty.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
